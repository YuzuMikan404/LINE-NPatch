name: NPatch LINE

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINEのバージョン (例: 15.12.2)'
        required: true

env:
  SOURCE_REPO: "YuzuMikan404/LINE-APK"
  KEYSTORE_FILE: "keystore.jks"
  STORE_PASSWORD: "your_store_password"
  KEY_ALIAS: "key0"
  KEY_PASSWORD: "your_store_password"

jobs:
  patch-line:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download Tools (NPatch)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NPATCH="7723mod/NPatch"
          LATEST_TAG=$(gh release list --repo "$REPO_NPATCH" --limit 1 --json tagName --jq '.[0].tagName')
          
          # JAR (パッチャー) と APK (マネージャー) をダウンロード
          # ファイル名が NPatch-v0.7.3-504-release.jar の形式に対応
          gh release download "$LATEST_TAG" --repo "$REPO_NPATCH" --pattern "NPatch-*-release.jar" --output "npatch.jar" --clobber
          gh release download "$LATEST_TAG" --repo "$REPO_NPATCH" --pattern "NPatch-*-release.apk" --output "manager.apk" --clobber
          
          wget -O APKEditor.jar "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"

      - name: Download LINE APK/APKM
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkdir download_tmp
          gh release download --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp || exit 1
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" -o -name "*.xapk" -o -name "*.apks" \) | head -n 1)
          mv "$FILE_PATH" raw_input.file

      - name: Prepare APK
        run: |
          if unzip -l raw_input.file | grep -q "base.apk"; then
            unzip -o raw_input.file -d splitted_apk
            java -jar APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input.file target.apk
          fi      
          
      - name: Patch with NPatch
        run: |
          mkdir -p output
          # 1. 強力な隠蔽: カレントディレクトリにあるJKSを完全に消す（バックアップは別ディレクトリへ）
          mkdir -p ../hide_keystore
          mv *.jks ../hide_keystore/ 2>/dev/null || true
          
          # 2. NPatch実行
          # --skip-sign を最初の方に持ってくることで、署名ロジックの初期化を防げる場合があります
          java -Xmx4G -jar npatch.jar --skip-sign target.apk --manager manager.apk --injectdex -f -o output
          
          # 3. 生成されたファイルを確認 (ファイル名にワイルドカードを使用)
          PATCHED_FILE=$(find output -name "*.apk" | head -n 1)
          
          if [ -z "$PATCHED_FILE" ]; then
            echo "::error::APKが生成されませんでした。NPatchが途中で停止しています。"
            exit 1
          fi
          
          # 4. マニフェストの存在チェックをより詳細に
          if ! unzip -l "$PATCHED_FILE" | grep -q "AndroidManifest.xml"; then
            echo "::error::APKにマニフェストが含まれていません。ビルドに失敗しています。"
            # デバッグ用に中身をリスト表示
            unzip -l "$PATCHED_FILE" | head -n 20
            exit 1
          fi
          
          mv "$PATCHED_FILE" target-patched.apk
          # JKSを復元
          mv ../hide_keystore/*.jks . 2>/dev/null || true

      - name: Zipalign and Sign APK
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          
          # 整列
          "$BUILD_TOOLS_DIR/zipalign" -v -f -p 4 target-patched.apk target-aligned.apk
          
          # 署名 (変数展開を防ぐためシングルクォートを使用)
          "$BUILD_TOOLS_DIR/apksigner" sign \
            --ks "${{ env.KEYSTORE_FILE }}" \
            --ks-pass pass:'${{ env.STORE_PASSWORD }}' \
            --ks-key-alias '${{ env.KEY_ALIAS }}' \
            --key-pass pass:'${{ env.KEY_PASSWORD }}' \
            --min-sdk-version 26 \
            --out signed_final.apk \
            target-aligned.apk

      - name: Zipalign and Sign APK
        run: |
          # 1. Android Build Toolsのパスを取得
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          
          # 2. zipalignを実行 (パッチ済みAPKを整列)
          "$BUILD_TOOLS_DIR/zipalign" -v -f -p 4 target-patched.apk target-aligned.apk
          
          # 3. apksignerで署名
          # 変数を '${{ env.VAR }}' とシングルクォートで囲むのがコツです
          "$BUILD_TOOLS_DIR/apksigner" sign \
            --ks "${{ env.KEYSTORE_FILE }}" \
            --ks-pass pass:'${{ env.STORE_PASSWORD }}' \
            --ks-key-alias '${{ env.KEY_ALIAS }}' \
            --key-pass pass:'${{ env.KEY_PASSWORD }}' \
            --min-sdk-version 26 \
            --out signed_final.apk \
            target-aligned.apk

      - name: Finalize Filename
        run: |
          # 入力されたバージョン名を使ってリネーム
          mv signed_final.apk "LINE-${{ github.event.inputs.version }}-NPatch.apk"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.version }}-npatch"
          name: "LINE ${{ github.event.inputs.version }} (NPatch)"
          body: |
            - **Tool:** NPatch (Neo LSPatch)
            - **Mode:** Local
            - **Method:** Inject Dex
          files: "LINE-${{ github.event.inputs.version }}-NPatch.apk"
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
