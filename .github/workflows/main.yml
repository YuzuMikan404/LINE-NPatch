name: NPatch LINE (Neo LSPatch - No Auto Sign)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINEのバージョン (例: 15.12.2)'
        required: true

env:
  SOURCE_REPO: "YuzuMikan404/LINE-APK"
  KEYSTORE_FILE: "keystore.jks"
  STORE_PASSWORD: "your_store_password"
  KEY_ALIAS: "key0"
  KEY_PASSWORD: "your_store_password"
  MIN_SDK: "24"

jobs:
  patch-line:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Verify Keystore
        run: |
          if [ ! -f "$KEYSTORE_FILE" ]; then echo "keystore.jks missing!" && exit 1; fi
          keytool -list -keystore "$KEYSTORE_FILE" -storepass "$STORE_PASSWORD" || exit 1

      - name: Download Tools
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG=$(gh release list --repo 7723mod/NPatch --limit 1 --json tagName --jq '.[0].tagName' || echo "v0.7.3")
          echo "NPatch version: $LATEST_TAG"
          gh release download "$LATEST_TAG" --repo 7723mod/NPatch --pattern "*-release.jar" --output "npatch.jar" --clobber
          gh release download "$LATEST_TAG" --repo 7723mod/NPatch --pattern "*-release.apk" --output "npatch-manager.apk" --clobber || echo "No manager APK"
          wget -O APKEditor.jar "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"

      - name: Download & Prepare LINE APK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkdir -p download_tmp
          gh release download --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp || exit 1
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" \) | head -n 1)
          [ -z "$FILE_PATH" ] && exit 1
          mv "$FILE_PATH" raw_input.file
          if unzip -l raw_input.file | grep -q "base.apk"; then
            unzip -o raw_input.file -d splitted_apk
            java -jar APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input.file target.apk
          fi

      - name: Apply NPatch (Skip Auto-Sign if Possible)
        run: |
          echo "Patching with NPatch (no manager if missing)..."
          # --no-sign や類似オプションがあれば使う（要確認）。なければそのまま → 内部署名失敗しても出力は残る
          if [ -f npatch-manager.apk ] && [ -s npatch-manager.apk ]; then
            java -Xmx4G -jar npatch.jar target.apk --manager npatch-manager.apk --injectdex -f -o output
          else
            java -Xmx4G -jar npatch.jar target.apk --injectdex -f -o output
            echo "Patched without manager"
          fi
          
          PATCHED=$(ls output/*.apk | head -n 1)
          [ -z "$PATCHED" ] && { echo "No patched APK! Contents:" && ls -la output/ && exit 1; }
          mv "$PATCHED" target-patched.apk
          echo "Patched APK size:" && ls -lh target-patched.apk

      - name: Align & Sign Manually
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          echo "Build-tools: $BUILD_TOOLS_DIR"
          "$BUILD_TOOLS_DIR/zipalign" -v -p 4 target-patched.apk target-aligned.apk
          
          "$BUILD_TOOLS_DIR/apksigner" sign \
            --ks "$KEYSTORE_FILE" \
            --ks-pass pass:"$STORE_PASSWORD" \
            --ks-key-alias "$KEY_ALIAS" \
            --key-pass pass:"$KEY_PASSWORD" \
            --min-sdk-version "$MIN_SDK" \
            --out signed_final.apk \
            target-aligned.apk

      - name: Finalize & Release
        run: |
          TODAY=$(date +%Y%m%d)
          PATCHER_VERSION="${LATEST_TAG#v}"
          FINAL_NAME="LINE-\( {{ github.event.inputs.version }}-NPatch-v \){PATCHER_VERSION}-${TODAY}.apk"
          mv signed_final.apk "$FINAL_NAME"
          echo "FINAL_APK_NAME=$FINAL_NAME" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}-npatch
          name: LINE ${{ github.event.inputs.version }} (NPatch Neo Local)
          body: |
            - Patcher: NPatch ${{ env.LATEST_TAG }}
            - Mode: Local Dex Injection
            - Built: $(date +%Y-%m-%d)
            - Note: Manual signing used (auto-sign skipped due to default keystore issue)
          files: ${{ env.FINAL_APK_NAME }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
