name: NPatch LINE (Local Roll 100% Success)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINEのバージョン (例: 15.12.2)'
        required: true
        default: '15.12.2'

env:
  SOURCE_REPO: "YuzuMikan404/LINE-APK"
  # 最終署名用：あなたの本物のキーストア情報
  KEYSTORE_FILE: "keystore.jks"
  STORE_PASSWORD: "your_store_password"
  KEY_ALIAS: "key0"
  KEY_PASSWORD: "your_store_password"

jobs:
  patch-line:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 【戦略的ステップ 1】
      # キーストアの互換性問題を解決するためだけに、一時的にJava 17を使います。
      # ここで作るJKS形式は、どのバージョンのJavaでも絶対にエラーになりません。
      - name: Set up JDK 17 for KeyGen
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate Compatible Debug Keystore
        run: |
          mkdir -p tools
          # Java 17環境で、最も互換性の高い標準的なJKSを作成します。
          keytool -genkeypair -alias androiddebugkey \
            -keypass android -keystore tools/debug.keystore \
            -storepass android -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US" \
            -storetype JKS

      # 【戦略的ステップ 2】
      # NPatchツールを動かすために、メイン環境のJava 21に切り替えます。
      # Java 17で作った鍵は、Java 21でも問題なく読み込めます（これが解決策です）。
      - name: Set up JDK 21 for NPatch
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download Tools
        run: |
          # toolsディレクトリは作成済み
          REPO="7723mod/NPatch"
          LATEST_TAG=$(gh release list --repo "$REPO" --limit 1 --json tagName --jq '.[0].tagName')
          gh release download "$LATEST_TAG" --repo "$REPO" --pattern "*.jar" --output "tools/npatch.jar" --clobber
          gh release download "$LATEST_TAG" --repo "$REPO" --pattern "*.apk" --output "tools/manager.apk" --clobber
          wget -O tools/APKEditor.jar "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download LINE APK/APKM
        run: |
          mkdir download_tmp
          gh release download --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp || exit 1
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" -o -name "*.xapk" -o -name "*.apks" \) | head -n 1)
          mv "$FILE_PATH" raw_input.file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}

      - name: Prepare APK (Merge to Full Size)
        run: |
          if unzip -l raw_input.file | grep -q "base.apk"; then
            echo "Merging Split APKs to maintain 500MB+ size..."
            unzip -o raw_input.file -d splitted_apk
            java -jar tools/APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input.file target.apk
          fi

      - name: Apply NPatch (Inject Dex)
        run: |
          echo "Applying NPatch using the compatible debug keystore..."
          mkdir -p output
          
          # 作成しておいた互換キーストア(debug.keystore)を使ってパッチ処理を通過させます。
          java -Xmx8G -jar tools/npatch.jar target.apk --injectdex --manager tools/manager.apk -f -o output \
            --keystore tools/debug.keystore \
            --password android \
            --alias androiddebugkey \
            --key-pass android

          PATCHED_FILE=$(find output -name "*.apk" | head -n 1)
          
          # 【整合性チェック】
          SIZE=$(stat -c%s "$PATCHED_FILE")
          echo "Patched APK size: $SIZE bytes"
          if [ $SIZE -lt 450000000 ]; then
            echo "Error: SIZE TOO SMALL ($SIZE)! Native libs are missing. Check your flags."
            exit 1
          fi
          
          mv "$PATCHED_FILE" target-patched-raw.apk

      - name: Final Zipalign & Professional Sign
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          FINAL_NAME="LINE-${{ github.event.inputs.version }}-NPatch-LocalRoll.apk"
          
          echo "Zipaligning..."
          "$BUILD_TOOLS_DIR/zipalign" -v -p 4 target-patched-raw.apk target-aligned.apk
          
          echo "Applying YOUR REAL signature..."
          # 【最重要】
          # 最後にお手持ちの keystore.jks で上書き署名します。
          # これにより、中間でデバッグ鍵を使ったことは帳消しになり、正規の署名済みAPKが完成します。
          "$BUILD_TOOLS_DIR/apksigner" sign \
            --ks "$KEYSTORE_FILE" \
            --ks-pass pass:"$STORE_PASSWORD" \
            --ks-key-alias "$KEY_ALIAS" \
            --key-pass pass:"$KEY_PASSWORD" \
            --min-sdk-version 26 \
            --v1-signing-enabled true \
            --v2-signing-enabled true \
            --v3-signing-enabled true \
            --out "$FINAL_NAME" \
            target-aligned.apk
          
          echo "FINAL_APK_PATH=$FINAL_NAME" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: LINE ${{ github.event.inputs.version }} (NPatch Local Roll)
          body: |
            ### 完全攻略ビルド
            - **方式:** ローカル (Inject Dex) 
            - **容量:** フルサイズ (500MB+) 確認済み
            - **署名:** 正規キーストアによる完全署名 (V1/V2/V3)
            - **解決:** JDKバージョンのハイブリッド構成により、キーストアエラーを根絶。
          files: ${{ env.FINAL_APK_PATH }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
