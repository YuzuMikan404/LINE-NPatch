name: NPatch LINE

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINE„ÅÆ„Éê„Éº„Ç∏„Éß„É≥ (‰æã: 15.12.2)'
        required: true

env:
  SOURCE_REPO: "YuzuMikan404/LINE-APK"

jobs:
  patch-line:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Decode Keystore from Secrets (NPatchÁî® PKCS12Êé®Â•®)
        env:
          NPATCH_KEYSTORE_BASE64: ${{ secrets.NPATCH_KEYSTORE_BASE64 }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD || 'your_store_password' }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'key0' }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'your_store_password' }}
        run: |
          if [ -z "$NPATCH_KEYSTORE_BASE64" ]; then
            echo "Error: NPATCH_KEYSTORE_BASE64 secret is not set"
            echo "Please encode your keystore with: base64 -w0 keystore.jks"
            exit 1
          fi

          mkdir -p keystore
          echo "$NPATCH_KEYSTORE_BASE64" | base64 -d > keystore/keystore.jks
          echo "‚úÖ Keystore decoded (size: $(wc -c < keystore/keystore.jks) bytes)"

          # JKS ‚Üí PKCS12Â§âÊèõÔºàNPatch„ÅØPKCS12„ÇíÊé®Â•®„ÉªÂÆâÂÆöÔºâ
          keytool -importkeystore \
            -srckeystore keystore/keystore.jks \
            -srcstoretype JKS \
            -destkeystore keystore/keystore.p12 \
            -deststoretype PKCS12 \
            -srcstorepass "$STORE_PASSWORD" \
            -deststorepass "$STORE_PASSWORD" \
            -srcalias "$KEY_ALIAS" \
            -destalias "$KEY_ALIAS" \
            -srckeypass "$KEY_PASSWORD" \
            -destkeypass "$KEY_PASSWORD" > /dev/null 2>&1 || echo "PKCS12Â§âÊèõ„Çπ„Ç≠„ÉÉ„ÉóÔºàÊó¢„Å´PKCS12„Åã„ÇÇÔºâ"

          echo "KEYSTORE_P12=keystore/keystore.p12" >> $GITHUB_ENV
          echo "STORE_PASSWORD=$STORE_PASSWORD" >> $GITHUB_ENV
          echo "KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
          echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV

      - name: Download Latest NPatch Tool
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # NPatch„ÅÆ„É™„Éù„Ç∏„Éà„É™„Åã„ÇâÊúÄÊñ∞„É™„É™„Éº„Çπ„ÅÆ„Çø„Ç∞„ÇíÂèñÂæó
          LATEST_TAG=$(gh release list --repo 7723mod/NPatch --limit 1 --json tagName --jq '.[0].tagName')
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not fetch latest tag from 7723mod/NPatch"
            exit 1
          fi
          echo "Latest NPatch tag: $LATEST_TAG"

          # ÊúÄÊñ∞„É™„É™„Éº„Çπ„Åã„ÇâNPatch„ÅÆjar„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºà„Éë„Çø„Éº„É≥„Åß„Éû„ÉÉ„ÉÅÔºâ
          gh release download "$LATEST_TAG" --repo 7723mod/NPatch --pattern "NPatch-*-release.jar" --output "NPatch.jar" --clobber
          if [ ! -f "NPatch.jar" ]; then
            echo "Error: No matching NPatch jar found in release $LATEST_TAG"
            echo "Available assets:"
            gh release view "$LATEST_TAG" --repo 7723mod/NPatch --json assets --jq '.assets[].name'
            exit 1
          fi
          echo "‚úÖ Downloaded latest NPatch: $(ls -l NPatch.jar)"

          # APKEditorÔºàAPKM/XAPKÂØæÂøúÁî®Ôºâ - „Åì„Çå„ÅØÂõ∫ÂÆö„ÅßOKÔºàÈ†ªÁπÅ„Å´Êõ¥Êñ∞„Åï„Çå„Å™„ÅÑÔºâ
          wget -O APKEditor.jar \
            "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"

      - name: Download LINE APK/APKM
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkdir download_tmp
          gh release download --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp || exit 1
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" -o -name "*.xapk" -o -name "*.apks" \) | head -n 1)
          if [ -z "$FILE_PATH" ]; then
            echo "Error: No suitable file found for version $VERSION"
            exit 1
          fi
          mv "$FILE_PATH" raw_input.file
          echo "ORIGINAL_FILENAME=$(basename "$FILE_PATH")" >> $GITHUB_ENV

      - name: Prepare APK
        run: |
          if unzip -l raw_input.file | grep -q "base.apk"; then
            echo "Detected split APKM/XAPK ‚Üí merging with APKEditor"
            unzip -o raw_input.file -d splitted_apk
            java -jar APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input.file target.apk
          fi

      - name: Apply NPatch
        run: |
          mkdir -p output
          java -Xmx4G -jar NPatch.jar --manager target.apk \
            -k ${{ env.KEYSTORE_P12 }} ${{ env.STORE_PASSWORD }} ${{ env.KEY_ALIAS }} ${{ env.KEY_PASSWORD }} \
            -o output -f

          PATCHED_FILE=$(find output -name "*-npatched.apk" -type f | head -n 1)
          if [ -n "$PATCHED_FILE" ]; then
            mv "$PATCHED_FILE" target-patched.apk
            echo "‚úÖ NPatch patching completed successfully"
          else
            echo "‚ùå No *-npatched.apk found ‚Üí patching failed"
            ls -la output || true
            exit 1
          fi

      - name: Verify Signature
        run: |
          echo "üîç Verifying output APK signature..."
          jarsigner -verify -keystore \( {{ env.KEYSTORE_P12 }} -storepass " \){{ env.STORE_PASSWORD }}" target-patched.apk
          if [ $? -eq 0 ]; then
            echo "‚úÖ Signature is VALID (matches the provided keystore)"
          else
            echo "‚ùå Signature verification FAILED"
            exit 1
          fi

      - name: Finalize Filename
        run: |
          FINAL_NAME="LINE-${{ github.event.inputs.version }}-NPatch.apk"
          mv target-patched.apk "$FINAL_NAME"
          echo "Final APK: $FINAL_NAME"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}-NPatch
          name: LINE ${{ github.event.inputs.version }} - NPatch (Latest Tool)
          body: |
            **Patch Tool:** NPatch (ÊúÄÊñ∞Ëá™ÂãïÂèñÂæóÁâà - 7723mod fork of LSPatch)  
            **Features:** Rootless LSPosed/Xposed module support  
            **Signature:** Custom keystore (override enabled)  
            **Installation:** Install as usual; use LSPosed Manager or compatible app to manage modules  
            **Note:** NPatch uses 'npatch' meta key (different from original LSPatch). Tool version fetched automatically from latest release.
          files: LINE-${{ github.event.inputs.version }}-NPatch.apk
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
