name: Patch LINE with NPatch

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINE version (e.g., 15.12.2)'
        required: true
        default: '15.12.2'

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: YuzuMikan404/LINE-NPatch

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download NPatch
        run: |
          LATEST_TAG=$(gh release list --repo 7723mod/NPatch --limit 1 --json tagName --jq '.[0].tagName' || echo "v0.7.3")
          echo "NPatch version: $LATEST_TAG"
          echo "PATCHER_VERSION=${LATEST_TAG#v}" >> $GITHUB_ENV
          gh release download "$LATEST_TAG" --repo 7723mod/NPatch --pattern "*-release.jar" --output "npatch.jar" --clobber
          gh release download "$LATEST_TAG" --repo 7723mod/NPatch --pattern "*-release.apk" --output "npatch-manager.apk" --clobber || echo "No manager APK"
          wget -O APKEditor.jar "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"
        env:
          GH_TOKEN: ${{ github.token }}
    
      - name: Download LINE APK
        run: |
          mkdir -p download_tmp
          gh release download --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp || exit 1
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" \) | head -n 1)
          [ -z "$FILE_PATH" ] && { echo "No file for $VERSION" && exit 1; }
          mv "$FILE_PATH" raw_input.file

          if unzip -l raw_input.file | grep -q "base.apk"; then
            unzip -o raw_input.file -d splitted_apk
            java -jar APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input.file target.apk
          fi
          ls -lh target.apk
        env:
          SOURCE_REPO: YuzuMikan404/LINE-APK
          VERSION: ${{ github.event.inputs.version }}
          GH_TOKEN: ${{ github.token }}

      - name: Create Keystore
        run: |
          # 新しいkeystoreを作成（パスワードなし、デバッグ用）
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias release \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          
          ls -lh release.keystore
          
      - name: Patch with NPatch (without signing)
        run: |
          echo "Patching..."
          # NPatchで署名なしでパッチ適用
          if [ -f npatch-manager.apk ] && [ -s npatch-manager.apk ]; then
            java -Xmx4G -jar npatch.jar target.apk --manager npatch-manager.apk --injectdex -f --nosign -o output
          else
            java -Xmx4G -jar npatch.jar target.apk --injectdex -f --nosign -o output
          fi

          PATCHED=$(ls output/*.apk 2>/dev/null | head -n 1)
          if [ -z "$PATCHED" ]; then
            echo "パッチ適用されたAPKが見つかりません"
            ls -la output/ || echo "outputディレクトリが存在しません"
            exit 1
          fi
          
          mv "$PATCHED" target-patched.apk
          echo "パッチ適用済みAPK:"
          ls -lh target-patched.apk

      - name: Zipalign and Sign APK
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          echo "Build-tools: $BUILD_TOOLS_DIR"
          
          # Zipalign
          "$BUILD_TOOLS_DIR/zipalign" -v -p 4 target-patched.apk target-aligned.apk
          
          # 署名
          "$BUILD_TOOLS_DIR/apksigner" sign \
            --ks release.keystore \
            --ks-pass pass:android \
            --ks-key-alias release \
            --key-pass pass:android \
            --out signed_final.apk \
            target-aligned.apk
          
          # 署名検証
          "$BUILD_TOOLS_DIR/apksigner" verify -v signed_final.apk
          
          echo "署名済みAPK:"
          ls -lh signed_final.apk

      - name: Finalize Filename
        run: |
          TODAY=$(date +%Y%m%d)
          INPUT_VERSION="${{ github.event.inputs.version }}"
          PATCHER_VERSION="${{ env.PATCHER_VERSION }}"
          
          FINAL_NAME="LINE-${INPUT_VERSION}-NPatch-v${PATCHER_VERSION}-${TODAY}.apk"
          
          echo "最終ファイル名: $FINAL_NAME"
          
          mv signed_final.apk "$FINAL_NAME"
          
          echo "FINAL_APK_NAME=$FINAL_NAME" >> $GITHUB_ENV
          
          ls -lh "$FINAL_NAME"
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}-npatch
          name: LINE ${{ github.event.inputs.version }} (NPatch)
          body: |
            ## LINE ${{ github.event.inputs.version }} - NPatch Edition
            
            - **Patcher Version:** NPatch v${{ env.PATCHER_VERSION }}
            - **Patch Mode:** Local Dex Injection
            - **Build Date:** $(date +%Y-%m-%d)
            - **Signing:** Release keystore (test key)
            
            ### インストール方法
            1. 既存のLINEアプリをアンインストール（データバックアップ推奨）
            2. このAPKをダウンロードしてインストール
            3. 初回起動時に権限を許可
            
            ### 注意事項
            - テスト用の署名キーを使用しています
            - 公式LINEとは署名が異なるため上書きインストールはできません
          files: ${{ env.FINAL_APK_NAME }}
          make_latest: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ github.token }}
