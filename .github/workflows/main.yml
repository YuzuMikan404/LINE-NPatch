name: NPatch LINE

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINEのバージョン (例: 15.12.2)'
        required: true

env:
  SOURCE_REPO: "YuzuMikan404/LINE-APK"
  KEYSTORE_FILE: "keystore.jks"              # リポジトリルートにあるファイル名
  STORE_PASSWORD: "your_store_password"      # ← 実際のパスワードに変更してください
  KEY_ALIAS: "key0"                          # ← 実際のエイリアスに変更してください
  KEY_PASSWORD: "your_store_password"        # ← 通常はSTORE_PASSWORDと同じ

jobs:
  patch-line:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Prepare Keystore (JKS → PKCS12)
        run: |
          if [ ! -f "${{ env.KEYSTORE_FILE }}" ]; then
            echo "❌ Keystore file '${{ env.KEYSTORE_FILE }}' not found in root!"
            ls -la
            exit 1
          fi

          echo "✅ Found keystore: \( {{ env.KEYSTORE_FILE }} ( \)(wc -c < ${{ env.KEYSTORE_FILE }}) bytes)"

          mkdir -p keystore
          cp "${{ env.KEYSTORE_FILE }}" keystore/original.jks

          # NPatchはPKCS12を推奨 → 変換
          keytool -importkeystore \
            -srckeystore keystore/original.jks \
            -srcstoretype JKS \
            -destkeystore keystore/keystore.p12 \
            -deststoretype PKCS12 \
            -srcstorepass "${{ env.STORE_PASSWORD }}" \
            -deststorepass "${{ env.STORE_PASSWORD }}" \
            -srcalias "${{ env.KEY_ALIAS }}" \
            -destalias "${{ env.KEY_ALIAS }}" \
            -srckeypass "${{ env.KEY_PASSWORD }}" \
            -destkeypass "${{ env.KEY_PASSWORD }}" > /dev/null 2>&1 || echo "⚠️ PKCS12変換失敗 → JKSをそのまま使用"

          if [ -f "keystore/keystore.p12" ]; then
            echo "KEYSTORE_P12=keystore/keystore.p12" >> $GITHUB_ENV
          else
            echo "KEYSTORE_P12=keystore/original.jks" >> $GITHUB_ENV
          fi

      - name: Download Latest NPatch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG=$(gh release list --repo 7723mod/NPatch --limit 1 --json tagName --jq '.[0].tagName')
          echo "Latest NPatch: $LATEST_TAG"

          gh release download "$LATEST_TAG" --repo 7723mod/NPatch --pattern "NPatch-*-release.jar" --output "NPatch.jar" --clobber

          if [ ! -f "NPatch.jar" ]; then
            echo "Fallback to v0.7.3"
            wget -O NPatch.jar https://github.com/7723mod/NPatch/releases/download/v0.7.3/NPatch-v0.7.3-504-release.jar
          fi

          wget -O APKEditor.jar "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"

      - name: Download LINE APK/APKM
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkdir download_tmp
          gh release download --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp || exit 1
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" -o -name "*.xapk" -o -name "*.apks" \) | head -n 1)
          mv "$FILE_PATH" raw_input.file
          echo "ORIGINAL_FILENAME=$(basename "$FILE_PATH")" >> $GITHUB_ENV

      - name: Prepare APK
        run: |
          if unzip -l raw_input.file | grep -q "base.apk"; then
            unzip -o raw_input.file -d splitted_apk
            java -jar APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input.file target.apk
          fi

      - name: Apply NPatch
        run: |
          mkdir -p output
          java -Xmx4G -jar NPatch.jar --manager target.apk \
            -k ${{ env.KEYSTORE_P12 }} ${{ env.STORE_PASSWORD }} ${{ env.KEY_ALIAS }} ${{ env.KEY_PASSWORD }} \
            -o output -f

          PATCHED_FILE=$(find output -name "*-npatched.apk" -type f | head -n 1)
          if [ -n "$PATCHED_FILE" ]; then
            mv "$PATCHED_FILE" target-patched.apk
            echo "✅ NPatch completed"
          else
            echo "❌ NPatch failed"
            ls output
            exit 1
          fi

      - name: Finalize Filename
        run: |
          mv target-patched.apk LINE-${{ github.event.inputs.version }}-NPatch.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}-NPatch
          name: LINE ${{ github.event.inputs.version }} (NPatch)
          body: |
            - **Mode:** NPatch (7723mod)
            - **Method:** NPatch patching
            - **Signature:** keystore.jks (hardcoded)
          files: LINE-${{ github.event.inputs.version }}-NPatch.apk
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
